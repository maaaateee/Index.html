<!DOCTYPE html>
<html lang="fr" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur Grilles 2E - Version ADP</title>
    <style>
        /* --- CSS NATIVE (ZERO DEPENDANCE) --- */
        :root {
            --bg-body: #f8fafc; --bg-card: #ffffff;
            --text-main: #1e293b; --text-muted: #64748b;
            --border: #e2e8f0; --nav-bg: rgba(255, 255, 255, 0.95);
            
            /* Couleurs M√©tier */
            --blue: #2563eb; --blue-light: #eff6ff; --blue-text: #1e40af;
            --indigo: #4f46e5; --indigo-light: #eef2ff; --indigo-text: #3730a3;
            --emerald: #10b981; --emerald-light: #ecfdf5; --emerald-text: #065f46;
            --orange: #f97316; --orange-light: #fff7ed; --orange-text: #9a3412;
            --purple: #9333ea; --purple-light: #faf5ff; --purple-text: #6b21a8;
            --red: #ef4444; --red-light: #fef2f2; --red-text: #991b1b;
            --teal: #14b8a6; --teal-light: #f0fdfa; --teal-text: #115e59;

            /* Codes Grille 2E */
            --c-nuit: #1e3a8a; --t-nuit: white;
            --c-jour: #fef9c3; --t-jour: #854d0e;
            --c-jfp: #fff1f2; --t-jfp: #9f1239;
            --c-jr1: #ecfccb; --t-jr1: #3f6212;
            --c-jmc: #ffedd5; --t-jmc: #9a3412;
            --c-jr24: #e0f2fe; --t-jr24: #075985;
            --c-void: white; --t-void: #cbd5e1;
        }

        html.dark {
            --bg-body: #0f172a; --bg-card: #1e293b;
            --text-main: #f1f5f9; --text-muted: #94a3b8;
            --border: #334155; --nav-bg: rgba(15, 23, 42, 0.95);
            --c-void: #334155; --t-void: #64748b;

            /* CORRECTIF DARK MODE - Fond des indicateurs sociaux */
            --orange-light: rgba(249, 115, 22, 0.15); --orange-text: #fb923c;
            --teal-light: rgba(20, 184, 166, 0.15); --teal-text: #2dd4bf;
            --emerald-light: rgba(16, 185, 129, 0.15); --emerald-text: #34d399;
            
            --blue-light: rgba(37, 99, 235, 0.15); --blue-text: #60a5fa;
            --indigo-light: rgba(79, 70, 229, 0.15); --indigo-text: #818cf8;
            --purple-light: rgba(147, 51, 234, 0.15); --purple-text: #a78bfa;
        }

        * { box-sizing: border-box; }
        body { margin:0; font-family: "Segoe UI", system-ui, sans-serif; background: var(--bg-body); color: var(--text-main); line-height: 1.5; font-size: 14px; transition: background 0.3s, color 0.3s; }
        
        /* Layout */
        .container { max-width: 1800px; margin: 0 auto; padding: 0 1rem; }
        .grid { display: grid; gap: 1.5rem; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
        .flex { display: flex; } .flex-col { flex-direction: column; }
        .items-center { align-items: center; } .justify-between { justify-content: space-between; } .justify-end { justify-content: flex-end; }
        .gap-2 { gap: 0.5rem; } .gap-4 { gap: 1rem; }
        .mt-2 { margin-top: 0.5rem; } .mt-4 { margin-top: 1rem; } .mb-4 { margin-bottom: 1rem; } .mb-8 { margin-bottom: 2rem; }
        .hidden { display: none !important; }

        /* Components */
        .card { background: var(--bg-card); border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--border); overflow: hidden; padding: 1.5rem; position: relative; }
        .card:hover { transform: translateY(-2px); transition: transform 0.2s; }
        .stat-icon-bg { position: absolute; top: 1rem; right: 1rem; opacity: 0.1; transform: scale(2); }

        /* --- BOUTONS --- */
        @keyframes pulse-border {
            0% { border-color: var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
            50% { border-color: var(--blue); box-shadow: 0 0 12px rgba(37, 99, 235, 0.25); }
            100% { border-color: var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        }

        .btn { 
            padding: 0.6rem 1.2rem; border-radius: 0.75rem; border: 1px solid var(--border); 
            background: linear-gradient(180deg, var(--bg-card) 0%, var(--bg-body) 100%);
            color: var(--text-muted); cursor: pointer; font-weight: 700; 
            display: flex; align-items: center; gap: 0.5rem; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; letter-spacing: 0.02em;
        }
        .btn:not(.active):not(:hover) { animation: pulse-border 3s infinite ease-in-out; }
        .btn:hover { background: #fff; border-color: var(--blue); color: var(--blue); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(37, 99, 235, 0.15); animation: none; }
        .btn.active { background: linear-gradient(135deg, var(--blue), var(--indigo)); color: white; border-color: transparent; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4); transform: scale(1.05); animation: none; z-index: 10; }
        
        /* Style sp√©cial pour le bouton Direction */
        .btn-purple:hover { border-color: var(--purple); color: var(--purple); box-shadow: 0 6px 12px rgba(147, 51, 234, 0.15); }
        .btn-purple.active { background: linear-gradient(135deg, var(--purple), #7e22ce); box-shadow: 0 4px 12px rgba(147, 51, 234, 0.4); }

        nav { position: sticky; top: 0; z-index: 50; background: var(--nav-bg); border-bottom: 1px solid var(--border); padding: 0.75rem 0; backdrop-filter: blur(8px); }

        /* Tables */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--bg-body); color: var(--text-muted); padding: 0.75rem; text-transform: uppercase; font-size: 0.75rem; text-align: center; border-bottom: 1px solid var(--border); }
        td { padding: 0.5rem; border: 1px solid var(--border); text-align: center; }
        .td-left { text-align: left; }

        /* Typography */
        .text-xs { font-size: 0.75rem; } .text-sm { font-size: 0.875rem; } .text-lg { font-size: 1.125rem; } .text-2xl { font-size: 1.5rem; } .text-3xl { font-size: 1.875rem; }
        .font-bold { font-weight: 700; } .uppercase { text-transform: uppercase; }
        
        /* Colors Util */
        .text-blue { color: var(--blue-text); } .text-indigo { color: var(--indigo-text); } .text-emerald { color: var(--emerald-text); }
        .text-purple { color: var(--purple-text); } .text-orange { color: var(--orange-text); } .text-red { color: var(--red-text); } .text-teal { color: var(--teal-text); }

        /* Codes Couleurs */
        select { width: 100%; text-align: center; text-align-last: center; border: none; font-weight: bold; cursor: pointer; padding: 4px; border-radius: 4px; appearance: none; -webkit-appearance: none; }
        
        .c-N2E, .c-NS3, .c-NS4 { background: var(--c-nuit); color: var(--t-nuit); }
        .c-J60H, .c-J2E, .c-JS3, .c-JS4 { background: var(--c-jour); color: var(--t-jour); }
        .c-JFP { background: var(--c-jfp); color: var(--t-jfp); }
        .c-JR1 { background: var(--c-jr1); color: var(--t-jr1); }
        .c-JMC { background: var(--c-jmc); color: var(--t-jmc); }
        .c-JR24 { background: var(--c-jr24); color: var(--t-jr24); }
        .c-RH { background: var(--c-void); color: var(--t-void); }

        .badge { display: inline-block; padding: 2px 8px; border-radius: 99px; font-size: 0.75rem; font-weight: 600; margin: 2px; }
        .badge-work { background: var(--blue-light); color: var(--blue-text); border: 1px solid currentColor; }
        .badge-rest { background: var(--emerald-light); color: var(--emerald-text); border: 1px solid currentColor; }
        .comp-ok { color: var(--emerald-text); font-weight: bold; }
        .comp-err { color: var(--red-text); font-weight: bold; }
        .comp-neutral { color: var(--text-muted); }

        svg { width: 1.25rem; height: 1.25rem; fill: currentColor; }
    </style>
</head>
<body>

<nav>
    <div class="container flex justify-between items-center" style="flex-wrap: wrap; gap:10px;">
        <div class="flex items-center gap-2">
            <div style="background:var(--blue); color:white; padding:6px; border-radius:6px;">
                <svg viewBox="0 0 512 512"><path d="M0 96C0 60.7 28.7 32 64 32H448c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96z"/></svg>
            </div>
            <div>
                <h1 class="font-bold text-lg" style="line-height:1">Simulateur 2E</h1>
                <span class="text-xs text-muted">Version ADP Secure</span>
            </div>
        </div>
        <div class="flex gap-2 flex-wrap justify-end">
            <button class="btn active" id="btn-actuel" onclick="switchTab('actuel')">GRILLE 39 (2022)</button>
            
            <!-- Groupe Projet/Direction -->
            <div class="flex flex-col gap-1">
                <button class="btn" id="btn-projet" onclick="switchTab('projet')">GRILLE 44 am√©lior√©</button>
                <button class="btn btn-purple" id="btn-direction" onclick="switchTab('direction')" style="font-size:0.7rem; padding:0.4rem 0.8rem; border-color:var(--purple); color:var(--purple);">GRILLE 44 (direction)</button>
            </div>

            <div class="flex flex-col gap-1">
                <button class="btn" id="btn-cible" onclick="switchTab('cible')">GRILLE 47</button>
                <button class="btn" id="btn-vierge" onclick="switchTab('vierge')" style="padding:0.3rem 0.8rem; font-size:0.75rem; border-style:dashed;">GRILLE 47 VIERGE</button>
            </div>
            <button class="btn" id="btn-compare" onclick="switchTab('compare')">COMPARATEUR</button>
            <button class="btn" onclick="document.documentElement.classList.toggle('dark')" style="border-radius:50%; padding:0.6rem; animation:none;">üåó</button>
        </div>
    </div>
</nav>

<main class="container mt-4">

    <!-- ALERTS -->
    <div id="rules-alert-box" class="card mb-4 hidden" style="border-left:4px solid; padding:1rem;">
        <div class="flex items-center gap-2 font-bold">
            <span id="alert-icon"></span>
            <span id="alert-title"></span>
        </div>
        <ul id="rules-alert-list" class="mt-2" style="padding-left:1.5rem; list-style:disc;"></ul>
        <p id="no-alert-msg" class="hidden mt-2 font-bold text-emerald">‚úÖ Grille Conforme : Toutes les r√®gles m√©tiers sont respect√©es.</p>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard-stats" class="grid grid-4 mb-8">
        <div class="card">
            <div class="stat-icon-bg text-blue"><svg viewBox="0 0 512 512"><path d="M256 0a256 256 0 1 1 0 512A256 256 0 1 1 256 0zM232 120V256c0 8 4 15.5 10.7 20l96 64c11 7.4 25.9 4.4 33.3-6.7s4.4-25.9-6.7-33.3L280 243.2V120c0-13.3-10.7-24-24-24s-24 10.7-24 24z"/></svg></div>
            <dt class="text-xs font-bold text-muted uppercase">Dur√©e Hebdo Moyenne</dt>
            <dd class="mt-2 text-3xl font-bold" id="disp-hebdo">--:--</dd>
            <div class="mt-2 text-xs text-muted"><span class="badge badge-work">Cible 37h30</span> <span id="disp-hebdo-ecart">--</span></div>
        </div>
        <div class="card">
            <div class="stat-icon-bg text-indigo"><svg viewBox="0 0 384 512"><path d="M223.5 32C100 32 0 132.3 0 256S100 480 223.5 480c60.6 0 115.5-24.2 155.8-63.4 5-4.9 6.3-12.5 3.1-18.7s-10.1-9.7-17-8.5c-9.8 1.7-19.8 2.6-30.1 2.6-96.9 0-175.5-78.8-175.5-176 0-65.8 36-123.1 89.3-153.3 6.1-3.5 9.2-10.5 7.7-17.3s-7.3-11.9-14.3-12.5c-6.3-.5-12.6-.8-19-.8z"/></svg></div>
            <dt class="text-xs font-bold text-muted uppercase">Charge Nuit / Agent</dt>
            <div class="flex items-baseline mt-2 gap-2">
                <dd class="text-3xl font-bold text-indigo" id="disp-nuits-an-nb">--</dd>
                <span class="text-sm font-bold text-indigo">nuits</span>
            </div>
            <p class="mt-2 text-xs text-muted" id="disp-nuits-an-h">-- heures</p>
        </div>
        <div class="card">
            <div class="stat-icon-bg text-emerald"><svg viewBox="0 0 640 512"><path d="M48 0C21.5 0 0 21.5 0 48V368c0 26.5 21.5 48 48 48H64c0 53 43 96 96 96s96-43 96-96H384c0 53 43 96 96 96s96-43 96-96h32c17.7 0 32-14.3 32-32s-14.3-32-32-32V288 256 237.3c0-17-6.7-33.3-18.7-45.3L512 114.7c-12-12-28.3-18.7-45.3-18.7H416V48c0-26.5-21.5-48-48-48H48z"/></svg></div>
            <dt class="text-xs font-bold text-muted uppercase">Fr√©quence Vacations</dt>
            <div class="flex items-baseline mt-2 gap-2">
                <dd class="text-3xl font-bold text-emerald" id="disp-vacs">--</dd>
                <span class="text-sm text-muted">/ sem</span>
            </div>
            <p class="mt-2 text-xs font-bold text-emerald" id="disp-vacs-an">-- / an</p>
        </div>
        <div class="card">
            <div class="stat-icon-bg text-purple"><svg viewBox="0 0 512 512"><path d="M64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64zM337 209L209 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L303 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/></svg></div>
            <dt class="text-xs font-bold text-muted uppercase">Total Major√© (Moy/Mois)</dt>
            <dd class="mt-2 text-3xl font-bold text-purple" id="disp-majo">--:--</dd>
            <div class="flex flex-col mt-1 text-xs text-muted">
                <div class="flex justify-between"><span class="text-blue">H. Nuit:</span> <span id="disp-majo-nuit" class="font-bold">--</span></div>
                <div class="flex justify-between"><span class="text-orange">H. Dim:</span> <span id="disp-majo-dim" class="font-bold">--</span></div>
            </div>
        </div>
    </div>

    <!-- SOCIAL & RHYTHM -->
    <div id="dashboard-social" class="grid grid-2 mb-8">
        <div class="card">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-blue"><svg viewBox="0 0 640 512"><path d="M144 0a80 80 0 1 1 0 160A80 80 0 1 1 144 0zM512 0a80 80 0 1 1 0 160A80 80 0 1 1 512 0zM0 298.7C0 239.8 47.8 192 106.7 192h42.7c15.9 0 31 3.5 44.6 9.7c-1.3 7.2-1.9 14.7-1.9 22.3c0 38.2 16.8 72.5 43.3 96c-.2 0-.4 0-.7 0H21.3C9.6 320 0 310.4 0 298.7zM405.3 320c-.2 0-.4 0-.7 0c26.6-23.5 43.3-57.8 43.3-96c0-7.6-.7-15-1.9-22.3c13.6-6.3 28.7-9.7 44.6-9.7h42.7C592.2 192 640 239.8 640 298.7c0 11.8-9.6 21.3-21.3 21.3H405.3zM224 224a96 96 0 1 1 192 0 96 96 0 1 1 -192 0zM128 485.3C128 411.7 187.7 352 261.3 352H378.7C452.3 352 512 411.7 512 485.3c0 14.7-11.9 26.7-26.7 26.7H154.7c-14.7 0-26.7-11.9-26.7-26.7z"/></svg>Indicateurs Sociaux</h2>
            <div class="grid grid-3 text-center">
                <div class="card" style="background:var(--orange-light); border:none;"><dt class="text-xs font-bold text-muted uppercase">Dimanches Trav.</dt><dd class="text-2xl font-bold text-orange" id="disp-dim-trav-nb">--</dd></div>
                <div class="card" style="background:var(--teal-light); border:none;"><dt class="text-xs font-bold text-muted uppercase">Dimanches Repos</dt><dd class="text-2xl font-bold text-teal" id="disp-dim-repos-nb">--</dd></div>
                <div class="card" style="background:var(--emerald-light); border:none;"><dt class="text-xs font-bold text-muted uppercase">WE Complets</dt><dd class="text-2xl font-bold text-emerald" id="disp-we-repos">--</dd></div>
            </div>
        </div>
        <div class="card">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-blue"><svg viewBox="0 0 512 512"><path d="M64 64c0-17.7-14.3-32-32-32S0 46.3 0 64V400c0 44.2 35.8 80 80 80H480c17.7 0 32-14.3 32-32s-14.3-32-32-32H80c-8.8 0-16-7.2-16-16V64zm406.6 86.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L320 210.7l-57.4-57.4c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L240 221.3l57.4 57.4c12.5 12.5 32.8 12.5 45.3 0l128-128z"/></svg>Analyse des Rythmes</h2>
            <div class="grid grid-2 gap-4">
                <div style="border-left:4px solid var(--blue); padding-left:10px;"><dt class="text-xs font-bold text-muted uppercase">S√©ries Vacations</dt><div id="disp-series-vac-detail" class="flex flex-wrap gap-1 mt-1"></div></div>
                <div style="border-left:4px solid var(--emerald); padding-left:10px;"><dt class="text-xs font-bold text-muted uppercase">S√©ries Repos</dt><div id="disp-series-repos-detail" class="flex flex-wrap gap-1 mt-1"></div></div>
            </div>
        </div>
    </div>

    <!-- GRILLE VIEW -->
    <div id="view-grid" class="card mb-8">
        <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-200">
            <h3 class="font-bold text-lg" id="grid-title">Grille Actuelle</h3>
            <div class="text-xs font-medium text-muted flex gap-2">
                <span class="flex items-center"><span class="c-N2E w-3 h-3 mr-1 rounded-full"></span> Nuit</span>
                <span class="flex items-center"><span class="c-J60H w-3 h-3 mr-1 rounded-full"></span> Jour</span>
            </div>
        </div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th class="w-10">#</th><th>Lun</th><th>Mar</th><th>Mer</th><th>Jeu</th><th>Ven</th><th>Sam</th><th>Dim</th>
                        <th>Dur√©e</th><th>H. Nuit</th><th>H. Dim</th><th>Total Majo</th><th>P√©nib.</th>
                    </tr>
                </thead>
                <tbody id="grid-body"></tbody>
            </table>
        </div>
    </div>

    <!-- RULES CONTROL -->
    <div id="view-rules-container" class="card mb-8">
        <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-200">
            <h3 class="font-bold text-lg text-emerald flex items-center gap-2"><svg viewBox="0 0 512 512"><path d="M173.9 439.4l-166.4-166.4c-10-10-10-26.2 0-36.2l36.2-36.2c10-10 26.2-10 36.2 0L192 312.7 432.1 72.6c10-10 26.2-10 36.2 0l36.2 36.2c10 10 10 26.2 0 36.2L210.1 439.4c-10 10-26.2 10-36.2 0z"/></svg>Contr√¥le des R√®gles</h3>
        </div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr><th class="td-left">Comp√©tence</th><th>Lun</th><th>Mar</th><th>Mer</th><th>Jeu</th><th>Ven</th><th>Sam</th><th>Dim</th></tr>
                </thead>
                <tbody id="rules-body"></tbody>
            </table>
        </div>
    </div>

    <!-- COMPARATOR -->
    <div id="view-compare" class="card hidden">
        <div class="mb-4 pb-4 border-b border-gray-200">
            <h3 class="font-bold text-lg">Comparatif Global</h3>
        </div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th class="td-left">Indicateur</th><th>ACTUEL (39)</th><th>PROJET (44)</th><th>DIRECTION (44)</th><th>CIBLE (47)</th>
                    </tr>
                </thead>
                <tbody id="compare-body"></tbody>
            </table>
        </div>
        <div class="mt-4 bg-blue-soft p-4 rounded text-xs text-blue-text border border-blue-200">
            <strong>Note:</strong> Score P√©nibilit√© Physio = (Nuits + Vacations)/an. Score P√©nibilit√© Social = (WE/Nuit Vendredi + Vacations)/an.
        </div>
    </div>

</main>

<script>
    function toggleDarkMode() { const h=document.documentElement; if(h.classList.contains('dark')){h.classList.remove('dark');h.classList.add('light');}else{h.classList.remove('light');h.classList.add('dark');} }
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) toggleDarkMode();

    const HORAIRES = {
        "J2E": {start:6,end:18,type:'jour',colorClass:'c-J2E'}, "J60H": {start:6,end:18,type:'jour',colorClass:'c-J60H'}, "JS3": {start:6,end:18,type:'jour',colorClass:'c-JS3'}, "JS4": {start:6,end:18,type:'jour',colorClass:'c-JS4'},
        "JFP": {start:6,end:18,type:'jour',colorClass:'c-JFP'}, "JMC": {start:6,end:18,type:'jour',colorClass:'c-JMC'}, "JR1": {start:6,end:16,type:'jour',colorClass:'c-JR1'}, "JR24": {start:6,end:16.5,type:'jour',colorClass:'c-JR24'},
        "N2E": {start:18,end:30,type:'nuit',colorClass:'c-N2E'}, "NS3": {start:18,end:30,type:'nuit',colorClass:'c-NS3'}, "NS4": {start:18,end:30,type:'nuit',colorClass:'c-NS4'}, "RH": {start:0,end:0,type:'repos',colorClass:'c-RH'}
    };

    const TARGETS = {
        "actuel": { "J2E":[2,2,2,2,2,2,2], "J60H":[0,0,0,0,0,0,0], "JMC":[0,1,1,1,1,0,0], "JR24":[0,0,0,0,0,0,0], "JS3":[2,2,2,2,2,2,2], "JS4":[2,2,2,2,2,2,2], "N2E":[2,2,2,2,2,2,2], "NS3":[2,2,2,2,2,2,2], "NS4":[2,2,2,2,2,2,2] },
        "projet": { "J2E":[3,3,3,3,3,3,3], "J60H":[0,0,0,0,0,0,0], "JFP":[0,5,0,0,0,0,0], "JR1":[0,0,0,0,0,0,0], "JS3":[2,2,2,2,2,2,2], "JS4":[2,2,2,2,2,2,2], "N2E":[2,2,2,2,2,2,2], "NS3":[2,2,2,2,2,2,2], "NS4":[2,2,2,2,2,2,2] },
        "direction": { "J2E":[3,3,3,3,3,3,3], "J60H":[0,0,0,0,0,0,0], "JFP":[0,5,0,0,0,0,0], "JR1":[0,0,0,0,0,0,0], "JS3":[2,2,2,2,2,2,2], "JS4":[2,2,2,2,2,2,2], "N2E":[2,2,2,2,2,2,2], "NS3":[2,2,2,2,2,2,2], "NS4":[2,2,2,2,2,2,2] },
        "cible": { "J2E":[3,3,3,3,3,3,3], "J60H":[0,0,0,0,0,0,0], "JFP":[0,5,0,0,0,0,0], "JR1":[0,0,0,0,0,0,0], "JS3":[2,2,2,2,2,2,2], "JS4":[2,2,2,2,2,2,2], "N2E":[3,3,3,3,3,3,3], "NS3":[2,2,2,2,2,2,2], "NS4":[2,2,2,2,2,2,2] },
        "vierge": { "J2E":[3,3,3,3,3,3,3], "J60H":[0,0,0,0,0,0,0], "JFP":[0,5,0,0,0,0,0], "JR1":[0,0,0,0,0,0,0], "JS3":[2,2,2,2,2,2,2], "JS4":[2,2,2,2,2,2,2], "N2E":[3,3,3,3,3,3,3], "NS3":[2,2,2,2,2,2,2], "NS4":[2,2,2,2,2,2,2] }
    };

    const RAW_DATA_ACTUEL = [
        ["RH", "RH", "RH", "JS4", "J60H", "NS3", "RH"], ["RH", "RH", "J2E", "J60H", "N2E", "RH", "RH"], ["RH", "J2E", "NS3", "NS4", "RH", "RH", "RH"], ["N2E", "NS3", "RH", "RH", "RH", "RH", "J2E"], ["J60H", "RH", "RH", "RH", "JS3", "N2E", "RH"], ["RH", "RH", "JR24", "J2E", "JMC", "RH", "RH"], ["RH", "JS3", "J60H", "RH", "RH", "J60H", "N2E"], ["RH", "RH", "RH", "RH", "J60H", "J2E", "J60H"], ["RH", "RH", "JS4", "J60H", "NS3", "RH", "RH"], ["RH", "JS4", "N2E", "NS3", "RH", "RH", "RH"], ["JS3", "NS4", "RH", "RH", "RH", "RH", "JS4"], ["J2E", "RH", "RH", "RH", "J2E", "NS4", "RH"], ["RH", "RH", "J60H", "JS3", "NS4", "RH", "RH"], ["RH", "J60H", "J60H", "RH", "RH", "JS3", "N2E"], ["NS4", "RH", "RH", "RH", "RH", "JS4", "J60H"], ["RH", "RH", "JMC", "JS3", "J60H", "RH", "RH"], ["RH", "J2E", "J60H", "N2E", "RH", "RH", "RH"], ["J60H", "NS3", "RH", "RH", "RH", "RH", "JS3"], ["JS4", "RH", "RH", "J2E", "JS3", "RH", "RH"], ["RH", "J60H", "NS4", "NS3", "RH", "RH", "RH"], ["RH", "J60H", "J60H", "RH", "RH", "J2E", "NS3"], ["NS4", "RH", "RH", "RH", "RH", "J60H", "NS3"], ["N2E", "RH", "RH", "RH", "JS4", "J60H", "RH"], ["RH", "JS3", "NS4", "N2E", "RH", "RH", "RH"], ["J2E", "N2E", "NS3", "RH", "RH", "RH", "RH"], ["RH", "RH", "RH", "J60H", "J60H", "NS3", "RH"], ["RH", "RH", "J60H", "J60H", "RH", "RH", "J60H"], ["J60H", "JMC", "RH", "RH", "RH", "J60H", "NS4"], ["NS3", "RH", "RH", "RH", "RH", "JS4", "J2E"], ["RH", "RH", "J2E", "J60H", "NS3", "RH", "RH"], ["RH", "JS4", "N2E", "NS4", "RH", "RH", "RH"], ["J60H", "NS4", "RH", "RH", "RH", "RH", "JS3"], ["JS4", "RH", "RH", "RH", "J2E", "N2E", "NS4"], ["RH", "RH", "RH", "J60H", "JS4", "NS4", "RH"], ["RH", "RH", "JS3", "JS4", "NS4", "RH", "RH"], ["RH", "J60H", "JS4", "JMC", "RH", "RH", "RH"], ["JS3", "N2E", "RH", "RH", "RH", "RH", "JS4"], ["NS3", "RH", "RH", "RH", "RH", "JS3", "J60H"], ["RH", "RH", "JS3", "J60H", "N2E", "RH", "RH"]
    ];

    const RAW_DATA_PROJET = [
        ["RH", "RH", "RH", "RH", "JR1", "J2E", "J60H"], ["RH", "RH", "J2E", "JFP", "N2E", "RH", "RH"], ["RH", "J2E", "NS3", "NS4", "RH", "RH", "RH"], ["JS4", "NS3", "RH", "RH", "RH", "RH", "J2E"], ["J60H", "RH", "RH", "JS3", "JS3", "RH", "RH"], ["J60H", "JS3", "N2E", "RH", "RH", "RH", "RH"], ["J60H", "J60H", "RH", "RH", "RH", "NS3", "N2E"], ["RH", "RH", "RH", "RH", "J2E", "J60H", "J60H"], ["RH", "RH", "JS4", "J2E", "NS3", "RH", "RH"], ["RH", "JS4", "J60H", "NS3", "RH", "RH", "RH"], ["JS3", "NS4", "RH", "RH", "RH", "RH", "JS4"], ["N2E", "RH", "RH", "RH", "RH", "J60H", "J60H"], ["RH", "RH", "J60H", "JS3", "NS4", "RH", "RH"], ["RH", "J60H", "J60H", "RH", "RH", "JS3", "N2E"], ["NS4", "RH", "RH", "RH", "RH", "JS4", "J60H"], ["RH", "RH", "JFP", "J60H", "J60H", "RH", "RH"], ["RH", "J60H", "J60H", "RH", "RH", "RH", "J60H"], ["NS4", "RH", "RH", "RH", "RH", "J60H", "JS3"], ["N2E", "RH", "RH", "J2E", "J2E", "RH", "RH"], ["J60H", "J60H", "NS4", "RH", "RH", "RH", "RH"], ["RH", "J60H", "JFP", "N2E", "RH", "RH", "RH"], ["J2E", "J60H", "RH", "RH", "RH", "N2E", "NS3"], ["RH", "RH", "RH", "JS4", "JS4", "NS3", "RH"], ["RH", "JS3", "J60H", "N2E", "RH", "RH", "RH"], ["J2E", "NS3", "NS4", "RH", "RH", "RH", "RH"], ["RH", "RH", "JR1", "J60H", "J60H", "RH", "RH"], ["RH", "RH", "J60H", "JR1", "RH", "RH", "J60H"], ["J60H", "N2E", "RH", "RH", "RH", "J2E", "NS4"], ["NS3", "RH", "RH", "RH", "RH", "JS4", "J2E"], ["RH", "RH", "J2E", "J60H", "NS3", "RH", "RH"], ["RH", "JS4", "J60H", "NS3", "RH", "RH", "RH"], ["J60H", "NS4", "RH", "RH", "RH", "RH", "JS3"], ["JS4", "RH", "RH", "RH", "J2E", "NS4", "NS4"], ["RH", "RH", "RH", "JS4", "JS4", "NS4", "RH"], ["RH", "RH", "JS3", "J2E", "NS4", "RH", "RH"], ["RH", "J2E", "JS4", "RH", "RH", "RH", "J2E"], ["JS3", "N2E", "RH", "RH", "RH", "J2E", "NS3"], ["NS3", "RH", "RH", "RH", "RH", "JS3", "JS4"], ["RH", "RH", "JS3", "J60H", "J60H", "RH", "RH"], ["RH", "RH", "RH", "JFP", "JS3", "N2E", "RH"], ["RH", "RH", "J2E", "J60H", "N2E", "RH", "RH"], ["RH", "J2E", "NS3", "NS4", "RH", "RH", "RH"], ["J2E", "J60H", "N2E", "RH", "RH", "RH", "RH"], ["RH", "RH", "RH", "RH", "J60H", "J60H", "J60H"]
    ];

    const RAW_DATA_DIRECTION = [
        ["RH","RH","RH","RH","JR1","J2E","J60H"],
        ["RH","RH","J2E","J60H","N2E","RH","RH"],
        ["RH","J2E","NS3","NS4","RH","RH","RH"],
        ["N2E","NS3","RH","RH","RH","RH","J2E"],
        ["J60H","RH","RH","RH","JS3","N2E","RH"],
        ["RH","RH","J60H","J2E","J60H","RH","RH"],
        ["RH","JS3","J60H","RH","RH","NS3","N2E"],
        ["RH","RH","RH","RH","J2E","J2E","J60H"],
        ["RH","RH","JS4","J60H","NS3","RH","RH"],
        ["RH","JS4","N2E","NS3","RH","RH","RH"],
        ["JS3","NS4","RH","RH","RH","RH","JS4"],
        ["N2E","RH","RH","RH","RH","J60H","J60H"],
        ["RH","RH","J60H","JS3","NS4","RH","RH"],
        ["RH","JFP","J60H","RH","RH","JS3","N2E"],
        ["NS4","RH","RH","RH","RH","JS4","J60H"],
        ["RH","RH","JFP","JS3","J60H","RH","RH"],
        ["RH","J2E","J60H","N2E","RH","RH","RH"],
        ["NS4","NS3","RH","RH","RH","RH","JS3"],
        ["JS4","RH","RH","J2E","J2E","RH","RH"],
        ["J60H","J60H","NS4","RH","RH","RH","RH"],
        ["RH","JFP","JR1","J60H","RH","RH","RH"],
        ["J2E","JFP","RH","RH","RH","N2E","NS3"],
        ["RH","RH","RH","J60H","JS4","J60H","RH"],
        ["RH","JS3","J60H","N2E","RH","RH","RH"],
        ["J2E","N2E","NS4","RH","RH","RH","RH"], /* L25 Corrected to N2E */
        ["RH","RH","RH","JS4","J60H","NS4","RH"],
        ["RH","RH","J60H","JR1","RH","RH","J60H"],
        ["J60H","J60H","RH","RH","RH","J2E","NS4"],
        ["NS3","RH","RH","RH","RH","JS4","J2E"],
        ["RH","RH","J2E","J60H","NS3","RH","RH"],
        ["RH","JS4","N2E","NS3","RH","RH","RH"],
        ["J60H","NS4","RH","RH","RH","RH","JS3"],
        ["JS4","RH","RH","RH","J2E","NS3","NS4"],
        ["RH","RH","RH","JS4","JS4","NS4","RH"],
        ["RH","RH","JS3","J2E","NS4","RH","RH"],
        ["RH","JFP","JS4","J60H","RH","RH","RH"],
        ["JS3","N2E","RH","RH","RH","J60H","NS3"],
        ["NS3","RH","RH","RH","RH","JS3","JS4"],
        ["RH","RH","JS3","J60H","J60H","RH","RH"],
        ["RH","RH","RH","RH","JS3","J60H","J60H"],
        ["RH","RH","J2E","J60H","N2E","RH","RH"],
        ["RH","J2E","NS3","NS4","RH","RH","RH"],
        ["J2E","JFP","RH","RH","RH","RH","J2E"],
        ["J60H","RH","RH","RH","RH","J60H","J60H"]
    ];

    const RAW_DATA_CIBLE = [
        ["RH", "RH", "RH", "RH", "JR1", "J2E", "J60H"], ["RH", "RH", "J2E", "J60H", "N2E", "RH", "RH"], ["RH", "J2E", "NS3", "NS4", "RH", "RH", "RH"], ["JS4", "NS3", "RH", "RH", "RH", "RH", "J2E"], ["J60H", "RH", "RH", "JS3", "JS3", "RH", "RH"], ["J60H", "JS3", "N2E", "RH", "RH", "RH", "RH"], ["J60H", "J60H", "RH", "RH", "RH", "NS3", "N2E"], ["RH", "RH", "RH", "RH", "J2E", "J60H", "J60H"], ["RH", "RH", "JS4", "J2E", "NS3", "RH", "RH"], ["RH", "JS4", "JFP", "NS3", "RH", "RH", "RH"], ["JS3", "NS4", "RH", "RH", "RH", "RH", "JS4"], ["N2E", "RH", "RH", "RH", "RH", "J60H", "J60H"], ["RH", "RH", "J60H", "J60H", "NS4", "RH", "RH"], ["RH", "J60H", "J60H", "RH", "RH", "JS3", "N2E"], ["NS4", "RH", "RH", "RH", "RH", "JS4", "J60H"], ["RH", "RH", "JFP", "J60H", "N2E", "RH", "RH"], ["RH", "J2E", "J60H", "RH", "RH", "RH", "J60H"], ["NS4", "RH", "RH", "RH", "RH", "J60H", "JS3"], ["N2E", "RH", "RH", "J2E", "J2E", "RH", "RH"], ["J60H", "J60H", "NS4", "RH", "RH", "RH", "RH"], ["RH", "J60H", "JR1", "N2E", "RH", "RH", "RH"], ["J2E", "NS3", "RH", "RH", "RH", "N2E", "NS3"], ["RH", "RH", "RH", "JFP", "JS4", "NS3", "RH"], ["RH", "JS3", "J60H", "N2E", "RH", "RH", "RH"], ["J2E", "J60H", "NS4", "RH", "RH", "RH", "RH"], ["RH", "RH", "RH", "JS4", "JS4", "NS4", "RH"], ["RH", "RH", "J60H", "JR1", "J60H", "RH", "RH"], ["J60H", "N2E", "RH", "RH", "RH", "J2E", "NS4"], ["NS3", "RH", "RH", "RH", "RH", "JS4", "J2E"], ["RH", "RH", "J2E", "JS4", "NS3", "RH", "RH"], ["RH", "JS4", "J60H", "NS3", "RH", "RH", "RH"], ["J60H", "NS4", "RH", "RH", "RH", "RH", "JS3"], ["JS4", "RH", "RH", "RH", "J2E", "NS4", "NS4"], ["RH", "RH", "J60H", "J60H", "J60H", "RH", "RH"], ["RH", "RH", "JS3", "J2E", "NS4", "RH", "RH"], ["RH", "J60H", "JS4", "RH", "RH", "RH", "J2E"], ["JS3", "N2E", "RH", "RH", "RH", "J2E", "NS3"], ["NS3", "RH", "RH", "RH", "RH", "JS3", "JS4"], ["RH", "RH", "JS3", "J60H", "J60H", "RH", "RH"], ["RH", "RH", "RH", "JFP", "JS3", "N2E", "RH"], ["RH", "RH", "J2E", "J60H", "N2E", "RH", "RH"], ["RH", "J2E", "N2E", "NS4", "RH", "RH", "RH"], ["J2E", "J60H", "N2E", "RH", "RH", "RH", "RH"], ["J60H", "J60H", "NS3", "RH", "RH", "RH", "RH"], ["N2E", "N2E", "RH", "RH", "RH", "J60H", "N2E"], ["RH", "RH", "RH", "JS3", "J60H", "N2E", "RH"], ["RH", "J60H", "JFP", "N2E", "RH", "RH", "RH"]
    ];
    
    const RAW_DATA_VIERGE = Array.from({length: 47}, () => Array(7).fill("RH"));

    let appState = {
        mode: 'actuel',
        data: {
            actuel: RAW_DATA_ACTUEL.map((p,i)=>({id:i+1, planning:p})),
            projet: RAW_DATA_PROJET.map((p,i)=>({id:i+1, planning:p})),
            direction: RAW_DATA_DIRECTION.map((p,i)=>({id:i+1, planning:p})),
            cible: RAW_DATA_CIBLE.map((p,i)=>({id:i+1, planning:p})),
            vierge: RAW_DATA_VIERGE.map((p,i)=>({id:i+1, planning:p}))
        }
    };

    function calculateGridStats(data) {
        let totH=0, totMaj=0, totRawNuit=0, totRawSun=0, totNuit=0, totVac=0, alerts=0, viol=[], soc=0, phys=0, dim=0, we=0;
        let flat = [], vacMap={}, repMap={};
        let rowStats = data.map(() => ({ dur:0, maj:0, rawNuit:0, rawDim:0 }));
        let nb = data.length || 1;

        let linearSchedule = [];
        data.forEach(r => r.planning.forEach(c => linearSchedule.push(HORAIRES[c])));
        data.slice(0, 2).forEach(r => r.planning.forEach(c => linearSchedule.push(HORAIRES[c])));

        let consecWork = 0, consecNuit = 0;
        for (let i = 0; i < linearSchedule.length - 1; i++) {
            const curr = linearSchedule[i], next = linearSchedule[i+1];
            if (curr.type !== 'repos' && next.type !== 'repos') {
                const gap = (next.start + 24) - curr.end;
                if (gap < 12) { if (!viol.includes(`Repos < 12h`)) { viol.push(`Repos < 12h`); alerts++; } }
            }
            if (curr.type !== 'repos') { consecWork++; if (curr.type === 'nuit') consecNuit++; else consecNuit = 0; } 
            else { consecWork = 0; consecNuit = 0; }
            if (consecWork > 3) { if (!viol.includes("S√©rie > 3 vacations")) { viol.push("S√©rie > 3 vacations"); alerts++; } }
            if (consecNuit > 2) { if (!viol.includes("S√©rie > 2 nuits")) { viol.push("S√©rie > 2 nuits"); alerts++; } }
        }

        data.forEach((r, i) => {
            let wD=0, s=false, d=false;
            r.planning.forEach((c, dayIdx) => {
                const h = HORAIRES[c];
                if (!h || h.type === 'repos') { flat.push(0); return; }
                flat.push(1); wD++; totVac++;
                
                const start = h.start, end = h.end;
                for (let t = start; t < end; t += 0.5) {
                    let hour = t % 24;
                    let isNextDay = t >= 24;
                    let actualDay = (dayIdx + (isNextDay ? 1 : 0)) % 7;
                    let isNight = (hour >= 22 || hour < 6);
                    let isSunday = (actualDay === 6);
                    let targetRow = i;
                    if (dayIdx === 6 && isNextDay) targetRow = (i + 1) % nb; 
                    rowStats[targetRow].dur += 0.5;
                    if (isNight) rowStats[targetRow].rawNuit += 0.5;
                    if (isSunday) rowStats[targetRow].rawDim += 0.5;
                    if (isNight || isSunday) rowStats[targetRow].maj += 0.5;
                }

                if (h.type === 'nuit') { totNuit++; phys++; if (dayIdx === 4) soc++; }
                if(dayIdx === 5) { s=true; soc++; } 
                if(dayIdx === 6) { d=true; dim++; soc++; } 
            });
            if(!s && !d) we++;
            if(wD>6) { alerts++; viol.push(`Ligne ${r.id}: >6 jours`); }
        });
        
        rowStats.forEach((rs, idx) => {
            totH += rs.dur; totMaj += rs.maj; totRawNuit += rs.rawNuit; totRawSun += rs.rawDim;
            if (rs.dur > 42.01) { viol.push(`Ligne ${idx+1}: > 42h`); alerts++; }
            if (rs.dur < 28 && rs.dur > 0) { viol.push(`Ligne ${idx+1}: < 28h`); alerts++; }
        });

        let cur=0, type=flat[0];
        [...flat, ...flat.slice(0,7)].forEach(v => {
            if(v===type) cur++; else { if(cur>0) (type ? vacMap : repMap)[cur] = ( (type ? vacMap : repMap)[cur] || 0 ) + 1; type=v; cur=1; }
        });
        if (vacMap[1] > 0) { viol.push("Vacation isol√©e"); alerts++; }

        return {
            moy: totH/nb, majMois: (totMaj/nb)*(52/12), rawNuitMois: (totRawNuit/nb)*(52/12), rawSunMois: (totRawSun/nb)*(52/12),
            nuitAn: Math.round((totNuit/nb)*52), vacAn: Math.round((totVac/nb)*52), vacSem: totVac/nb,
            dimAn: (dim / nb) * 52, weAn: (we / nb) * 52,
            physAn: Math.round((phys/nb)*52 + (totVac/nb)*52), socAn: Math.round((soc/nb)*52 + (totVac/nb)*52),
            viol: [...new Set(viol)], vacMap, repMap, fac: 52/nb, alerts, rowStats 
        };
    }

    /* CORRECTION CALCUL COMPARATEUR */
    function fmt(d) {
        const sign = d < 0 ? "-" : "";
        const abs = Math.abs(d);
        let h = Math.floor(abs);
        let m = Math.round((abs - h) * 60);
        if (m === 60) { h++; m = 0; }
        return `${sign}${h}h${m < 10 ? '0' + m : m}`;
    }

    function updateCell(r, c, val) { appState.data[appState.mode][r].planning[c] = val; render(); }

    function render() {
        if(appState.mode === 'compare') { renderCompare(); return; }
        const d = appState.data[appState.mode], s = calculateGridStats(d);
        
        const safeSet = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
        safeSet('disp-hebdo', fmt(s.moy)); safeSet('disp-hebdo-ecart', (s.moy-37.5>0?'+':'') + fmt(s.moy-37.5));
        safeSet('disp-nuits-an-nb', s.nuitAn); safeSet('disp-nuits-an-h', Math.round(s.nuitAn*8) + ' h');
        safeSet('disp-vacs', s.vacSem.toFixed(2)); safeSet('disp-vacs-an', s.vacAn + ' / an');
        safeSet('disp-majo', fmt(s.majMois)); safeSet('disp-majo-nuit', fmt(s.rawNuitMois)); safeSet('disp-majo-dim', fmt(s.rawSunMois));
        safeSet('disp-dim-trav-nb', Math.round(s.dimAn)); safeSet('disp-dim-repos-nb', Math.round(52 - s.dimAn)); safeSet('disp-we-repos', Math.round(s.weAn));

        const vd = document.getElementById('disp-series-vac-detail'); if(vd) { vd.innerHTML=''; Object.keys(s.vacMap).sort((a,b)=>a-b).forEach(k => { if(k>=2) vd.innerHTML += `<span class="badge badge-work">${Math.round(s.vacMap[k]*s.fac/2)} x ${k}j</span>`; }); }
        const rd = document.getElementById('disp-series-repos-detail'); if(rd) { rd.innerHTML=''; Object.keys(s.repMap).sort((a,b)=>a-b).forEach(k => { if(k>=2) rd.innerHTML += `<span class="badge badge-rest">${Math.round(s.repMap[k]*s.fac/2)} x ${k}j</span>`; }); }

        const ab = document.getElementById('rules-alert-box'), al = document.getElementById('rules-alert-list'), at = document.getElementById('alert-title'), ai = document.getElementById('alert-icon'), ok = document.getElementById('no-alert-msg');
        ab.classList.remove('hidden');
        if (s.alerts > 0 || s.viol.length > 0) {
            ab.style.backgroundColor="#fef2f2"; ab.style.borderColor="#ef4444"; ab.style.color="#991b1b";
            ai.innerHTML='‚ö†Ô∏è'; at.innerText='R√®gles non respect√©es';
            al.innerHTML = s.viol.map(v => `<li>${v}</li>`).join(''); ok.classList.add('hidden'); al.classList.remove('hidden');
        } else {
            ab.style.backgroundColor="#f0fdf4"; ab.style.borderColor="#10b981"; ab.style.color="#065f46";
            ai.innerHTML='‚úÖ'; at.innerText='Conforme';
            al.innerHTML = ''; ok.classList.remove('hidden'); al.classList.add('hidden');
        }

        const tb = document.getElementById('grid-body'); tb.innerHTML = '';
        d.forEach((r, ri) => {
            const tr = document.createElement('tr');
            let h = `<td class="font-bold bg-slate-50 dark:bg-slate-800/50 text-center border-r border-slate-200 dark:border-slate-700">${r.id}</td>`;
            let nPen = 0;
            r.planning.forEach((c, ci) => {
                if(HORAIRES[c]?.type==='nuit') nPen++;
                let opts = Object.keys(HORAIRES).filter(k=>k).map(k=>`<option value="${k}" ${c===k?'selected':''}>${k}</option>`).join('');
                h += `<td style="padding:2px; border:1px solid var(--border);"><select class="${HORAIRES[c]?.colorClass||'c-RH'}" onchange="updateCell(${ri},${ci},this.value)"><option value="RH">--</option>${opts}</select></td>`;
            });
            const rs = s.rowStats[ri];
            let durClass = ""; if (rs.dur > 42.01) durClass = "text-red font-bold"; if (rs.dur < 28 && rs.dur > 0) durClass = "text-orange font-bold"; 
            h += `<td class="${durClass} font-bold">${fmt(rs.dur)}</td><td class="text-blue font-bold">${fmt(rs.rawNuit)}</td><td class="text-orange font-bold">${fmt(rs.rawDim)}</td><td class="text-purple font-bold border-l" style="border-color:var(--border)">${fmt(rs.maj)}</td><td class="text-indigo font-bold">${nPen}</td>`;
            tr.innerHTML = h; tb.appendChild(tr);
        });
        renderRules(d);
    }

    function renderRules(d) {
        const tb = document.getElementById('rules-body'); tb.innerHTML = '';
        const tg = TARGETS[appState.mode] || {};
        const counts = {}; Object.keys(tg).forEach(k => counts[k] = [0,0,0,0,0,0,0]);
        d.forEach(r => r.planning.forEach((c, i) => { if(counts[c]) counts[c][i]++; }));
        Object.keys(tg).forEach(k => {
            const tr = document.createElement('tr');
            let h = `<td class="td-left font-bold flex items-center"><span class="${HORAIRES[k]?.colorClass} w-3 h-3 inline-block rounded mr-2"></span>${k}</td>`;
            counts[k].forEach((v, i) => { 
                const t = tg[k][i]; 
                let cls = 'comp-neutral'; if (t > 0) cls = (v === t) ? 'comp-ok' : 'comp-err';
                h += `<td><span class="${cls}">${v} / ${t}</span></td>`;
            });
            tr.innerHTML = h; tb.appendChild(tr);
        });
    }

    function renderCompare() {
        const s1 = calculateGridStats(appState.data.actuel), s2 = calculateGridStats(appState.data.projet), sD = calculateGridStats(appState.data.direction), s3 = calculateGridStats(appState.data.cible);
        const tb = document.getElementById('compare-body'); tb.innerHTML = '';
        const row = (l, v1, v2, vD, v3, f=(x)=>x, rev=false) => {
            const d2=v2-v1, dD=vD-v1, d3=v3-v1;
            const c2 = d2===0 ? 'text-muted' : ((d2>0 ^ rev) ? 'text-red' : 'text-emerald');
            const cD = dD===0 ? 'text-muted' : ((dD>0 ^ rev) ? 'text-red' : 'text-emerald');
            const c3 = d3===0 ? 'text-muted' : ((d3>0 ^ rev) ? 'text-red' : 'text-emerald');
            return `<tr><td class="td-left font-bold text-muted text-sm">${l}</td>
                <td class="font-bold">${f(v1)}</td>
                <td class="font-bold">${f(v2)} <span class="text-xs ${c2}">(${d2>0?'+':''}${f(d2)})</span></td>
                <td class="font-bold text-purple">${f(vD)} <span class="text-xs ${cD}">(${dD>0?'+':''}${f(dD)})</span></td>
                <td class="font-bold">${f(v3)} <span class="text-xs ${c3}">(${d3>0?'+':''}${f(d3)})</span></td></tr>`;
        };
        let h = row("Dur√©e Hebdo", s1.moy, s2.moy, sD.moy, s3.moy, fmt);
        h += row("Vacations / An", s1.vacAn, s2.vacAn, sD.vacAn, s3.vacAn);
        h += row("Total Heures Nuit / An", Math.round(s1.nuitAn*8), Math.round(s2.nuitAn*8), Math.round(sD.nuitAn*8), Math.round(s3.nuitAn*8), x=>x+'h');
        h += row("Dimanches Repos", Math.round(52-s1.dimAn), Math.round(52-s2.dimAn), Math.round(52-sD.dimAn), Math.round(52-s3.dimAn), x=>x, true);
        h += row("WE Complets", Math.round(s1.weAn), Math.round(s2.weAn), Math.round(sD.weAn), Math.round(s3.weAn), x=>x, true);
        h += row("Total Major√© (Moy/Mois)", s1.majMois, s2.majMois, sD.majMois, s3.majMois, fmt, true);
        h += row("Score Physio (An)", s1.physAn, s2.physAn, sD.physAn, s3.physAn, x=>x, false);
        h += row("Score Social (An)", s1.socAn, s2.socAn, sD.socAn, s3.socAn, x=>x, false);
        tb.innerHTML = h;
    }

    function switchTab(m) {
        appState.mode = m;
        ['actuel','projet','direction','cible','compare','vierge'].forEach(x => {
            const b = document.getElementById('btn-'+x);
            if(b) { if(x===m) { b.classList.add('active'); b.classList.remove('text-muted'); } else { b.classList.remove('active'); b.classList.add('text-muted'); } }
        });
        const isCmp = m==='compare';
        ['view-grid','dashboard-stats','dashboard-social','view-rules-container'].forEach(i=>document.getElementById(i).classList.toggle('hidden', isCmp));
        document.getElementById('view-compare').classList.toggle('hidden', !isCmp);
        if(!isCmp) { document.getElementById('grid-title').innerText = `Grille ${m.toUpperCase()} (${appState.data[m].length} Lignes)`; render(); } else renderCompare();
    }

    switchTab('actuel');
</script>
</body>
</html>
